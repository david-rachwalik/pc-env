---
# ansible-playbook app_create.yml -e "app_repo_names=['DMR']"
# appc --tags ad -e "app_repo_names=['DMR']"
# appc --tags ad

- hosts: azure
  tasks:
  - name: Login Azure Active Directory subscription
    include_role:
      name: azure/active_directory/subscription
    tags: [azure, az, active_directory, ad, subscription, login]

  - name: Create Azure Active Directory application
    include_role:
      name: azure/active_directory/application/create
      tasks_from: loop_app_repos
    tags: [azure, az, active_directory, ad, application, identity]

  # create key vault to store service principals, passwords, connection strings, etc.
  # create credential file if missing


- hosts: windows
  tasks:
  - name: Create .NET Core application repository
    include_role:
      name: windows/apps/dotnet/create
      tasks_from: loop_app_project
    tags: [repository, repo, dotnet, new, git]


# Modes: [nodb, sqlserver, docker] (when F1, ignore custom domain)

# https://docs.microsoft.com/en-us/azure/ansible/ansible-create-configure-azure-web-apps
# https://docs.microsoft.com/en-us/learn/paths/deploy-a-website-with-azure-app-service/
# https://www.youtube.com/playlist?list=PLdo4fOcmZ0oW8nviYduHq7bmKode-p8Wy
# https://docs.microsoft.com/en-us/azure/ansible/ansible-overview
# https://docs.ansible.com/ansible/latest/modules/list_of_cloud_modules.html#azure

# - name: Create Azure WebApp Service
#   hosts: azure
#   tasks:
#   - include_role:
#       name: azure/app_service/create
#     loop: "{{app_repo_names}}"
#     loop_control:
#       loop_var: app_repo
#   tags: [azure, az, app_service, publish, host]


# Modes: [blob, website] (when F1, ignore custom domain)

# https://docs.microsoft.com/en-us/azure/ansible/ansible-overview
# https://docs.ansible.com/ansible/latest/modules/list_of_cloud_modules.html#azure

# https://www.youtube.com/watch?v=G_gDYlRBAZw
# https://docs.microsoft.com/en-us/azure/storage/blobs/storage-blob-static-website
# - name: Create Azure Static App Service (blog storage)
#   hosts: azure
#   vars:
#     resource_group: StaticWebsite
#     storage_account: superfancysitename
#   roles:
#   - azure/storage_account/create


- hosts: azure
  tasks:
  # - include_role:
  #     name: azure/resources/managed_identity
  # - include_role:
  #     name: azure/resources/service_principal

  - name: Deploy Azure Resource Manager Template
    include_role:
      name: azure/resource_manager/deploy
      tasks_from: loop_app_repo
    tags: [azure, az, deploy, resource_manager, arm]

  - name: Deploy Azure Pipelines
    include_role:
      name: azure/pipelines/deploy
      tasks_from: loop_app_repo
    tags: [azure, az, deploy, pipelines]
...